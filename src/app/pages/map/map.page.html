<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button (click)="goBackToHome()" fill="clear">
        <ion-icon name="arrow-back-outline" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>Heritage Landmarks</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="debugMapStatus()" fill="clear">
        <ion-icon name="bug-outline" slot="icon-only"></ion-icon>
      </ion-button>
      <ion-button (click)="recenterToUser()" fill="clear">
        <ion-icon name="locate-outline" slot="icon-only"></ion-icon>
      </ion-button>
      <ion-button (click)="clearFilters()" fill="clear">
        <ion-icon name="refresh-outline" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
  
  <ion-toolbar *ngIf="!loading">
    <ion-searchbar 
      [(ngModel)]="searchQuery"
      (ionInput)="updateMarkers()"
      placeholder="Search landmarks..."
      show-clear-button="focus"
      debounce="300">
    </ion-searchbar>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <div *ngIf="loading" class="loading-container">
    <ion-spinner name="crescent"></ion-spinner>
    <p>Loading curator-approved landmarks...</p>
  </div>

  <ion-card class="filter-card" *ngIf="!loading">
    <ion-card-header>
      <ion-card-title>
        <ion-icon name="filter-outline"></ion-icon>
        Filter Landmarks
      </ion-card-title>
    </ion-card-header>
    <ion-card-content>

      <ion-item>
        <ion-label position="stacked">Category</ion-label>
        <ion-select 
          [(ngModel)]="categoryFilter"
          (ionChange)="updateMarkers()"
          placeholder="All categories">
          <ion-select-option value="">All Categories</ion-select-option>
          <ion-select-option 
            *ngFor="let category of availableCategories" 
            [value]="category">
            {{ category }}
          </ion-select-option>
        </ion-select>
      </ion-item>

      <ion-item>
        <ion-label position="stacked">City</ion-label>
        <ion-select 
          [(ngModel)]="cityFilter"
          (ionChange)="updateMarkers()"
          placeholder="All cities">
          <ion-select-option value="">All Cities</ion-select-option>
          <ion-select-option 
            *ngFor="let city of availableCities" 
            [value]="city">
            {{ city }}
          </ion-select-option>
        </ion-select>
      </ion-item>

      <ion-item>
        <ion-label position="stacked">Difficulty</ion-label>
        <ion-select 
          [(ngModel)]="difficultyFilter"
          (ionChange)="updateMarkers()"
          placeholder="All difficulties">
          <ion-select-option value="">All Difficulties</ion-select-option>
          <ion-select-option value="easy">Easy</ion-select-option>
          <ion-select-option value="medium">Medium</ion-select-option>
          <ion-select-option value="hard">Hard</ion-select-option>
        </ion-select>
      </ion-item>

      <div class="results-info">
        <ion-chip color="primary" outline="true">
          <ion-icon name="location-outline"></ion-icon>
          <ion-label>
            {{ displayedLandmarksCount }} of {{ totalLandmarksCount }} landmarks
          </ion-label>
        </ion-chip>
        
        <ion-button 
          (click)="clearFilters()" 
          fill="outline" 
          size="small" 
          color="medium">
          <ion-icon name="refresh-outline" slot="start"></ion-icon>
          Clear Filters
        </ion-button>
      </div>
    </ion-card-content>
  </ion-card>

  <div id="map" class="map-container" *ngIf="!loading">
    <div *ngIf="!mapLoaded" class="map-loading">
      <ion-spinner name="crescent"></ion-spinner>
      <p>Loading map...</p>
    </div>
    
    <div class="map-fab-container">
      <ion-fab-button 
        (click)="recenterToUser()" 
        class="fab-user-location"
        color="primary">
        <ion-icon name="locate-outline"></ion-icon>
      </ion-fab-button>
      
      <ion-fab-button 
        (click)="debugMapStatus()" 
        class="fab-debug"
        color="secondary">
        <ion-icon name="bug-outline"></ion-icon>
      </ion-fab-button>
      
      <ion-fab-button 
        (click)="addSampleLandmarks()" 
        class="fab-add-landmarks"
        color="tertiary">
        <ion-icon name="add-outline"></ion-icon>
      </ion-fab-button>
      
      <ion-fab-button 
        (click)="refreshLocation()" 
        class="fab-refresh-location"
        color="success">
        <ion-icon name="refresh-outline"></ion-icon>
      </ion-fab-button>
    </div>
  </div>

  <ion-card *ngIf="!loading && filteredLandmarks.length === 0" class="no-results-card">
    <ion-card-content class="ion-text-center">
      <ion-icon name="location-outline" size="large" color="medium"></ion-icon>
      <h2>No landmarks found</h2>
      <p *ngIf="totalLandmarksCount === 0">
        No curator-approved landmarks have been added yet.<br>
        Curators can add landmarks through the web administration panel.
      </p>
      <p *ngIf="totalLandmarksCount > 0">
        No landmarks match your current search criteria.
      </p>
      <ion-button 
        *ngIf="totalLandmarksCount > 0"
        (click)="clearFilters()" 
        fill="outline">
        Clear Filters
      </ion-button>
    </ion-card-content>
  </ion-card>

  <ion-list *ngIf="!loading && filteredLandmarks.length > 0" class="landmark-list">
    <ion-list-header>
      <ion-label>
        <h2>Heritage Landmarks</h2>
        <p>{{ filteredLandmarks.length }} curator-approved locations</p>
      </ion-label>
    </ion-list-header>

    <ion-item 
      *ngFor="let landmark of filteredLandmarks; trackBy: trackByLandmark"
      [attr.data-landmark-id]="landmark.id">
      
      <ion-thumbnail slot="start">
        <img [src]="getDefaultImageUrl(landmark.imageUrl, landmark.category, landmark.id, landmark.name)" [alt]="landmark.name" (error)="onImageError($event)">
      </ion-thumbnail>
      
      <ion-label>
        <h3>{{ landmark.name }}</h3>
        <p>{{ landmark.description | slice:0:100 }}{{ landmark.description && landmark.description.length > 100 ? '...' : '' }}</p>
        
        <div class="landmark-meta">
          <ion-chip size="small" color="primary" outline="true">
            {{ landmark.category }}
          </ion-chip>
          <ion-chip size="small" color="secondary" outline="true" *ngIf="landmark.city">
            {{ landmark.city }}
          </ion-chip>
          <ion-chip size="small" color="success" outline="true">
            <ion-icon name="checkmark-circle-outline" size="small"></ion-icon>
            <ion-label>Curator Approved</ion-label>
          </ion-chip>
          <ion-chip 
            *ngIf="landmark.arContent" 
            size="small" 
            color="tertiary" 
            outline="true">
            <ion-icon name="camera-outline" size="small"></ion-icon>
            <ion-label>AR</ion-label>
          </ion-chip>
        </div>
      </ion-label>

      <div class="landmark-actions" slot="end">
        <ion-button 
          fill="clear" 
          size="small" 
          (click)="getDirectionsToLandmark(landmark.id)"
          title="Get Directions">
          <ion-icon name="navigate-outline"></ion-icon>
        </ion-button>
        <ion-button 
          fill="clear" 
          size="small" 
          (click)="navigateToLandmark(landmark.id)"
          title="View Details">
          <ion-icon name="chevron-forward-outline"></ion-icon>
        </ion-button>
      </div>
    </ion-item>
  </ion-list>

  <div class="directions-panel" *ngIf="directionsPanelVisible && showDirections">
    <ion-card>
      <ion-card-header>
        <div class="directions-header">
          <h3>ðŸ§­ Directions to {{ selectedLandmark?.name }}</h3>
          <ion-button fill="clear" size="small" (click)="clearRoute()">
            <ion-icon name="close-outline"></ion-icon>
          </ion-button>
        </div>
        
        <div class="route-profile-selector">
          <ion-segment [(ngModel)]="routeProfile" (ionChange)="changeRouteProfile($event.detail.value)">
            <ion-segment-button value="walking">
              <ion-icon name="walk"></ion-icon>
              <ion-label>Walk</ion-label>
            </ion-segment-button>
            <ion-segment-button value="driving">
              <ion-icon name="car"></ion-icon>
              <ion-label>Drive</ion-label>
            </ion-segment-button>
            <ion-segment-button value="cycling">
              <ion-icon name="bicycle"></ion-icon>
              <ion-label>Bike</ion-label>
            </ion-segment-button>
          </ion-segment>
        </div>

        <div class="route-summary" *ngIf="routeDistance && routeDuration">
          <ion-chip color="primary">
            <ion-icon name="time-outline"></ion-icon>
            <ion-label>{{ routeDuration }}</ion-label>
          </ion-chip>
          <ion-chip color="secondary">
            <ion-icon name="location-outline"></ion-icon>
            <ion-label>{{ routeDistance }}</ion-label>
          </ion-chip>
        </div>
      </ion-card-header>

      <ion-card-content>
        <div *ngIf="isCalculatingRoute" class="loading-directions">
          <ion-spinner name="crescent"></ion-spinner>
          <p>Calculating route...</p>
        </div>

        <div class="route-steps" *ngIf="!isCalculatingRoute && routeSteps.length > 0">
          <ion-item *ngFor="let step of routeSteps; let i = index" class="route-step">
            <ion-icon
              [name]="getStepIcon(step.maneuver.type)"
              slot="start"
              [color]="i === 0 ? 'primary' : 'medium'">
            </ion-icon>
            <ion-label>
              <h4>{{ step.maneuver.instruction }}</h4>
              <p *ngIf="step.distance > 0">{{ formatDistance(step.distance) }}</p>
            </ion-label>
          </ion-item>
        </div>

        <div *ngIf="!isCalculatingRoute && routeSteps.length === 0" class="no-route">
          <ion-icon name="warning-outline" color="warning"></ion-icon>
          <p>No route found. Using simple directions.</p>
        </div>

        <div class="route-actions">
          <ion-button expand="block" fill="outline" (click)="openInExternalMaps()">
            <ion-icon name="open-outline" slot="start"></ion-icon>
            Open in Maps
          </ion-button>
        </div>
      </ion-card-content>
    </ion-card>
  </div>

  <ion-fab-button
    (click)="clearRoute()"
    class="fab-clear-route"
    color="danger"
    *ngIf="showDirections">
    <ion-icon name="close-outline"></ion-icon>
  </ion-fab-button>
</ion-content>