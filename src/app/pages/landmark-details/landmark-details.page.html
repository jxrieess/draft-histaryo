<ion-header class="modern-header">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/home" class="back-button"></ion-back-button>
    </ion-buttons>
    <ion-title class="title-header">
      <div class="title-content">
        <h1 class="landmark-title">{{ landmark?.name || 'Loadingâ€¦' }}</h1>
        <p class="landmark-subtitle" *ngIf="landmark?.city">{{ landmark?.city }}</p>
      </div>
    </ion-title>
    <ion-buttons slot="end" class="header-actions">
      <ion-button fill="clear" (click)="toggleBookmark()" *ngIf="landmark" class="action-btn">
        <ion-icon 
          [name]="isBookmarked ? 'bookmark' : 'bookmark-outline'" 
          [color]="isBookmarked ? 'warning' : 'medium'">
        </ion-icon>
      </ion-button>
      <ion-button fill="clear" (click)="shareLandmark()" *ngIf="landmark" class="action-btn">
        <ion-icon name="share-outline" color="primary"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding" [fullscreen]="true">

  <div class="loading-container" *ngIf="loading">
    <div class="loading-content">
      <div class="loading-spinner">
        <ion-spinner name="crescent"></ion-spinner>
      </div>
      <h3>Loading Landmark</h3>
      <p>Fetching details and media...</p>
      
      <div class="skeleton-content">
        <div class="skeleton-hero"></div>
        <div class="skeleton-tabs">
          <div class="skeleton-tab"></div>
          <div class="skeleton-tab"></div>
          <div class="skeleton-tab"></div>
        </div>
        <div class="skeleton-cards">
          <div class="skeleton-card"></div>
          <div class="skeleton-card"></div>
          <div class="skeleton-card"></div>
        </div>
      </div>
    </div>
  </div>

  <ng-container *ngIf="!loading && landmark">

    <div class="hero-section">
      <div class="hero-image-container">
        <img 
          [src]="getDefaultImageUrl(landmark.imageUrl, landmark.category)" 
          [alt]="landmark.name" 
          class="hero-image"
          (error)="onImageError($event)" />
        
        <div class="hero-overlay">
          <div class="hero-content">
            <div class="hero-badges">
              <ion-chip color="primary" *ngIf="landmark.category" class="category-chip">
                <ion-icon name="location" slot="start"></ion-icon>
                <ion-label>{{ landmark.category }}</ion-label>
              </ion-chip>
              <ion-chip color="success" *ngIf="isStamped" class="visited-chip">
                <ion-icon name="checkmark-circle"></ion-icon>
                <ion-label>Visited</ion-label>
              </ion-chip>
            </div>
            
            <div class="hero-actions">
              <ion-button 
                expand="block" 
                color="primary" 
                size="large"
                class="ar-launch-btn"
                (click)="launchArExperience()"
                [disabled]="!arContent">
                <ion-icon name="camera" slot="start"></ion-icon>
                {{ arContent ? 'Launch AR Experience' : 'AR Not Available' }}
              </ion-button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="tab-navigation">
      <ion-segment 
        [(ngModel)]="activeTab" 
        value="story" 
        class="modern-segment"
        (ionChange)="onTabChange($event)">
        <ion-segment-button value="story" class="segment-button">
          <ion-icon name="book" slot="start"></ion-icon>
          <ion-label>Story</ion-label>
        </ion-segment-button>
        <ion-segment-button 
          value="then" 
          *ngIf="landmark.thenUrl || landmark.nowUrl"
          class="segment-button">
          <ion-icon name="swap-horizontal" slot="start"></ion-icon>
          <ion-label>Then & Now</ion-label>
        </ion-segment-button>
        <ion-segment-button 
          value="media" 
          *ngIf="hasMedia"
          class="segment-button">
          <ion-icon name="images" slot="start"></ion-icon>
          <ion-label>Media</ion-label>
        </ion-segment-button>
        <ion-segment-button 
          value="info" 
          *ngIf="hasAdditionalInfo"
          class="segment-button">
          <ion-icon name="information-circle" slot="start"></ion-icon>
          <ion-label>Details</ion-label>
        </ion-segment-button>
      </ion-segment>
    </div>

    <div *ngIf="activeTab === 'story'" class="story-content">
      <div class="content-container">
        <ion-card class="main-card">
          <ion-card-content>
            <div class="card-header">
              <h2 class="card-title">{{ landmark.name }}</h2>
              <div class="card-meta" *ngIf="landmark.city">
                <ion-icon name="location" color="primary"></ion-icon>
                <span>{{ landmark.city }}</span>
              </div>
            </div>
            
            <p class="description-text">{{ landmark.description }}</p>
          </ion-card-content>
        </ion-card>

        <ion-card *ngIf="hasLocationData" class="info-card">
          <ion-card-content>
            <div class="card-header">
              <ion-icon name="navigate" color="primary" class="card-icon"></ion-icon>
              <h3 class="card-title">Location</h3>
            </div>
            <p class="location-text">{{ locationString }}</p>
            <ion-button 
              size="small"
              fill="outline" 
              color="primary"
              (click)="openInMaps()"
              class="location-btn">
              <ion-icon name="map" slot="start"></ion-icon>
              Open in Maps
            </ion-button>
          </ion-card-content>
        </ion-card>

        <ion-card *ngIf="landmark.historicalSignificance" class="info-card">
          <ion-card-content>
            <div class="card-header">
              <ion-icon name="library" color="primary" class="card-icon"></ion-icon>
              <h3 class="card-title">Historical Significance</h3>
            </div>
            <p class="info-text">{{ landmark.historicalSignificance }}</p>
          </ion-card-content>
        </ion-card>

        <ion-card *ngIf="landmark.constructionDate || landmark.architect" class="info-card">
          <ion-card-content>
            <div class="card-header">
              <ion-icon name="hammer" color="primary" class="card-icon"></ion-icon>
              <h3 class="card-title">Construction Details</h3>
            </div>
            <div class="details-grid">
              <div class="detail-item" *ngIf="landmark.constructionDate">
                <span class="detail-label">Built</span>
                <span class="detail-value">{{ landmark.constructionDate }}</span>
              </div>
              <div class="detail-item" *ngIf="landmark.architect">
                <span class="detail-label">Architect</span>
                <span class="detail-value">{{ landmark.architect }}</span>
              </div>
              <div class="detail-item" *ngIf="landmark.architecturalStyle">
                <span class="detail-label">Style</span>
                <span class="detail-value">{{ landmark.architecturalStyle }}</span>
              </div>
            </div>
          </ion-card-content>
        </ion-card>

        <ion-card *ngIf="landmark.funFacts && landmark.funFacts.length > 0" class="info-card">
          <ion-card-content>
            <div class="card-header">
              <ion-icon name="bulb" color="warning" class="card-icon"></ion-icon>
              <h3 class="card-title">Fun Facts</h3>
            </div>
            <div class="facts-container">
              <div class="fact-item" *ngFor="let fact of landmark.funFacts; let i = index">
                <ion-icon name="star" color="warning" class="fact-icon"></ion-icon>
                <span class="fact-text">{{ fact }}</span>
              </div>
            </div>
          </ion-card-content>
        </ion-card>

        <ion-card *ngIf="landmark.visitingTips && landmark.visitingTips.length > 0" class="info-card">
          <ion-card-content>
            <div class="card-header">
              <ion-icon name="information-circle" color="success" class="card-icon"></ion-icon>
              <h3 class="card-title">Visiting Tips</h3>
            </div>
            <div class="tips-container">
              <div class="tip-item" *ngFor="let tip of landmark.visitingTips; let i = index">
                <ion-icon name="checkmark-circle" color="success" class="tip-icon"></ion-icon>
                <span class="tip-text">{{ tip }}</span>
              </div>
            </div>
          </ion-card-content>
        </ion-card>
      </div>
    </div>

    <div *ngIf="activeTab === 'then'" class="then-now-container">
      <div class="comparison-header">
        <h3>Then & Now Comparison</h3>
        <p>Slide to compare historical and current views</p>
      </div>
      
      <div class="twentytwenty-wrapper">
        <div class="twentytwenty-container">
          <img 
            [src]="landmark.thenUrl || getDefaultImageUrl(landmark.imageUrl, landmark.category)" 
            alt="Historical view" 
            class="comparison-image then-image" />
          <img
            [src]="landmark.nowUrl || getDefaultImageUrl(landmark.imageUrl, landmark.category)"
            [style.clipPath]="'inset(0 0 0 ' + (100 - sliderValue) + '%)'"
            alt="Current view"
            class="comparison-image now-image" />
        </div>
      </div>
      
      <ion-range 
        [(ngModel)]="sliderValue" 
        min="0" 
        max="100" 
        color="primary"
        (ionInput)="onSliderChange($event)"
        class="comparison-slider">
        <ion-label slot="start">Then</ion-label>
        <ion-label slot="end">Now</ion-label>
      </ion-range>
    </div>

    <div *ngIf="activeTab === 'media'" class="media-content">
      <ion-card *ngIf="landmark.videoUrl">
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="play-circle" color="primary"></ion-icon>
            Video Content
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <ion-button 
            expand="block"
            [href]="landmark.videoUrl" 
            target="_blank"
            rel="noopener"
            color="primary">
            <ion-icon name="play-circle" slot="start"></ion-icon>
            Watch Video
          </ion-button>
        </ion-card-content>
      </ion-card>

      <ion-card *ngIf="landmark.thenUrl || landmark.nowUrl">
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="images" color="primary"></ion-icon>
            Image Gallery
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <div class="image-gallery">
            <div class="gallery-item" *ngIf="landmark.thenUrl">
              <img [src]="landmark.thenUrl" alt="Historical view" />
              <p>Historical View</p>
            </div>
            <div class="gallery-item" *ngIf="landmark.nowUrl">
              <img [src]="landmark.nowUrl" alt="Current view" />
              <p>Current View</p>
            </div>
          </div>
        </ion-card-content>
      </ion-card>
    </div>

    <div class="actions-section">
      <h3 class="section-title">Interactive Features</h3>
      <div class="actions-grid">
        <ion-card 
          class="action-card"
          [class.disabled]="!hasScavengerHunt"
          (click)="startScavengerHunt()">
          <ion-card-content>
            <div class="action-content">
              <div class="action-icon">
                <ion-icon 
                  name="search" 
                  [color]="hasScavengerHunt ? 'tertiary' : 'medium'">
                </ion-icon>
              </div>
              <div class="action-text">
                <h4>Scavenger Hunt</h4>
                <p>{{ hasScavengerHunt ? 'Solve clues and explore interactively' : 'Coming soon!' }}</p>
              </div>
              <ion-icon 
                name="chevron-forward" 
                class="action-arrow"
                [color]="hasScavengerHunt ? 'primary' : 'medium'">
              </ion-icon>
            </div>
          </ion-card-content>
        </ion-card>

        <ion-card 
          class="action-card"
          [class.disabled]="triviaQuestions.length === 0"
          (click)="playTrivia()">
          <ion-card-content>
            <div class="action-content">
              <div class="action-icon">
                <ion-icon 
                  name="school" 
                  [color]="triviaQuestions.length > 0 ? 'secondary' : 'medium'">
                </ion-icon>
              </div>
              <div class="action-text">
                <h4>Play Trivia</h4>
                <p>{{ triviaQuestions.length > 0 ? 'Test your knowledge with ' + triviaQuestions.length + ' questions' : 'No trivia available yet' }}</p>
              </div>
              <ion-icon 
                name="chevron-forward" 
                class="action-arrow"
                [color]="triviaQuestions.length > 0 ? 'primary' : 'medium'">
              </ion-icon>
            </div>
          </ion-card-content>
        </ion-card>

        <ion-card 
          class="action-card"
          (click)="viewTips()">
          <ion-card-content>
            <div class="action-content">
              <div class="action-icon">
                <ion-icon name="information-circle-outline" color="primary"></ion-icon>
              </div>
              <div class="action-text">
                <h4>Visitor Tips</h4>
                <p>{{ userTips.length > 0 ? 'View ' + userTips.length + ' helpful tips' : 'Be the first to share a tip!' }}</p>
              </div>
              <ion-icon 
                name="chevron-forward" 
                class="action-arrow"
                color="primary">
              </ion-icon>
            </div>
          </ion-card-content>
        </ion-card>

        <ion-card 
          class="action-card"
          (click)="submitTip()">
          <ion-card-content>
            <div class="action-content">
              <div class="action-icon">
                <ion-icon name="add-circle-outline" color="success"></ion-icon>
              </div>
              <div class="action-text">
                <h4>Submit a Tip</h4>
                <p>Share your experience with other visitors</p>
              </div>
              <ion-icon 
                name="chevron-forward" 
                class="action-arrow"
                color="primary">
              </ion-icon>
            </div>
          </ion-card-content>
        </ion-card>
      </div>
    </div>

    <div class="stamp-section">
      <h3 class="section-title">Collection</h3>
      <ion-card class="stamp-card">
        <ion-card-content>
          <div class="stamp-content">
            <div class="stamp-visual">
              <div class="stamp-icon-container" [class.collected]="isStamped">
                <ion-icon 
                  [name]="isStamped ? 'checkmark-circle' : 'bookmark-outline'" 
                  [color]="isStamped ? 'success' : 'primary'"
                  class="stamp-icon">
                </ion-icon>
                <div class="stamp-ring" *ngIf="!isStamped"></div>
              </div>
              <div class="stamp-text">
                <h4>{{ isStamped ? 'Stamp Collected!' : 'Collect Stamp' }}</h4>
                <p>{{ isStamped ? 'You\'ve visited this landmark' : 'Visit to add this landmark to your collection' }}</p>
              </div>
            </div>
            
            <div class="stamp-actions">
              <ion-button 
                [color]="isStamped ? 'medium' : 'success'"
                [disabled]="isStamped"
                (click)="collectStamp()"
                class="collect-stamp-btn"
                size="small">
                <ion-icon 
                  [name]="isStamped ? 'checkmark-circle' : 'bookmark'" 
                  slot="start">
                </ion-icon>
                {{ isStamped ? 'Collected' : 'Collect Stamp' }}
              </ion-button>

              <ion-button 
                *ngIf="isStamped"
                size="small"
                fill="outline" 
                routerLink="/stamp-gallery"
                color="primary"
                class="view-collection-btn">
                <ion-icon name="trophy" slot="start"></ion-icon>
                View My Collection
              </ion-button>
            </div>
          </div>
        </ion-card-content>
      </ion-card>
    </div>

  </ng-container>

  <div class="ion-text-center ion-padding" *ngIf="!loading && !landmark">
    <ion-icon name="alert-circle" size="large" color="danger"></ion-icon>
    <h2>Landmark Not Found</h2>
    <p>The landmark you're looking for doesn't exist or has been removed.</p>
    <ion-button routerLink="/home" color="primary">
      <ion-icon name="home" slot="start"></ion-icon>
      Go Home
    </ion-button>
  </div>

</ion-content>

<ion-fab vertical="bottom" horizontal="end" slot="fixed" *ngIf="landmark && !loading">
  <ion-fab-button color="primary" size="small">
    <ion-icon name="ellipsis-horizontal"></ion-icon>
  </ion-fab-button>
  
  <ion-fab-list side="top">
    <ion-fab-button 
      (click)="launchArExperience()" 
      color="tertiary" 
      size="small"
      [disabled]="!arContent">
      <ion-icon name="camera"></ion-icon>
    </ion-fab-button>
    
    <ion-fab-button 
      (click)="openInMaps()" 
      color="secondary" 
      size="small"
      [disabled]="!hasLocationData">
      <ion-icon name="navigate"></ion-icon>
    </ion-fab-button>
    
    <ion-fab-button 
      (click)="shareLandmark()" 
      color="warning" 
      size="small">
      <ion-icon name="share"></ion-icon>
    </ion-fab-button>
  </ion-fab-list>
</ion-fab>